openapi: "3.0.3"
info:
  title: MoltPhone API
  version: "1.1.0"
  description: Agent voice call service with LIVE_AI_AGENT and RECORDED_MESSAGE modes, user registration, token economy, and Twilio integration
servers:
  - url: https://api.moltphone.xyz
    description: Production
paths:
  /health:
    get:
      summary: Health check
      responses:
        "200": { description: Service healthy }
  /ready:
    get:
      summary: Readiness check
      responses:
        "200": { description: Ready }
        "503": { description: Not ready }
  /register:
    post:
      summary: Register a new agent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [handle, name, email]
              properties:
                handle: { type: string, minLength: 3, maxLength: 32 }
                name: { type: string }
                email: { type: string, format: email }
      responses:
        "201": { description: Agent registered, API key returned }
        "400": { description: Validation failed }
        "409": { description: Handle already exists }
  /me:
    get:
      summary: Get current agent profile
      security: [{ BearerAuth: [] }]
      responses:
        "200": { description: Agent profile }
  /rotate-key:
    post:
      summary: Rotate API key
      security: [{ BearerAuth: [] }]
      responses:
        "200": { description: New API key returned }
  /tokens/balance:
    get:
      summary: Get token balance and available packages
      security: [{ BearerAuth: [] }]
      responses:
        "200": { description: Token balance }
  /tokens/purchase:
    post:
      summary: Purchase a token package
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [package]
              properties:
                package: { type: string, enum: [starter, pro, enterprise] }
      responses:
        "201": { description: Purchase successful }
        "400": { description: Invalid package }
  /tokens/history:
    get:
      summary: Get token purchase history
      security: [{ BearerAuth: [] }]
      parameters:
        - name: page
          in: query
          schema: { type: integer }
        - name: limit
          in: query
          schema: { type: integer }
      responses:
        "200": { description: Purchase history }
  /call:
    post:
      summary: Initiate an outbound call
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [to_number, assistant_config]
              properties:
                to_number: { type: string, pattern: '^\+[1-9]\d{1,14}$' }
                assistant_config:
                  type: object
                  required: [first_message, system_prompt]
                  properties:
                    first_message: { type: string }
                    system_prompt: { type: string }
                    voice: { type: string }
      responses:
        "201": { description: Call initiated, returns call details, twilioCallSid, and mode }
        "402": { description: Insufficient token balance }
        "429": { description: Rate limit exceeded }
        "503": { description: Voice calling service not configured }
  /call/end/{id}:
    post:
      summary: End an active call
      security: [{ BearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200": { description: Call ended }
        "404": { description: Call not found }
  /calls:
    get:
      summary: Get call history (paginated)
      security: [{ BearerAuth: [] }]
      parameters:
        - name: status
          in: query
          schema: { type: string }
        - name: limit
          in: query
          schema: { type: integer }
        - name: offset
          in: query
          schema: { type: integer }
      responses:
        "200": { description: Call history }
  /calls/{id}:
    get:
      summary: Get call details
      security: [{ BearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200": { description: Call details }
        "404": { description: Call not found }
  /calls/stats:
    get:
      summary: Get aggregate call statistics
      security: [{ BearerAuth: [] }]
      responses:
        "200": { description: Call statistics }
  /calls/{id}/transcript:
    get:
      summary: Get full transcript for a call
      security: [{ BearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200": { description: Call transcript }
        "404": { description: Call not found }
  /webhooks/vapi:
    post:
      summary: Receive webhook callbacks from Vapi (legacy)
      responses:
        "200": { description: Processed }
  /webhooks/twilio-status:
    post:
      summary: Receive Twilio call status callbacks
      description: Updates call record with status (completed/failed/busy/no-answer) and callResult (success/failure)
      responses:
        "200": { description: Processed }
  /webhooks/twilio-connect-action:
    post:
      summary: ConversationRelay session ended callback
      responses:
        "200": { description: Returns TwiML to end call }
  /twiml/conversation-relay:
    get:
      summary: TwiML webhook for ConversationRelay (called by Twilio)
      parameters:
        - name: callDocId
          in: query
          required: true
          schema: { type: string }
      responses:
        "200": { description: TwiML with ConversationRelay configuration }
  /webhooks/subscribe:
    post:
      summary: Subscribe to call event webhooks
      security: [{ BearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [url]
              properties:
                url: { type: string, format: uri }
                events: { type: array, items: { type: string } }
      responses:
        "201": { description: Subscribed }
  /webhooks:
    get:
      summary: List webhook subscriptions
      security: [{ BearerAuth: [] }]
      responses:
        "200": { description: Subscriptions }
  /webhooks/{id}:
    delete:
      summary: Remove webhook subscription
      security: [{ BearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200": { description: Removed }
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
