sprint: v02
name: "Core APIs — Agent Registration & MoltBank"
goal: |
  Implement the two foundational APIs that every other service depends on:
    • Agent registration with unified API-key auth (works across all services)
    • MoltBank wallet & escrow API (the flagship product)
  By the end of this sprint, agents can register, receive API keys,
  manage wallets, transfer USDC (simulated), and use escrow.
status: complete
completed_date: "2026-02-15"
progress: 100
estimated_hours: 14

stories:
  - id: SP-V02-001
    title: "Agent Registration API"
    description: |
      POST /register endpoint: validates handle, generates prefixed API key,
      hashes and stores key, returns it once. Auth middleware validates keys
      across all services.
    status: complete
    completed_date: "2026-02-15"
    effort: medium
    prd_refs: [PRD-002]
    roadmap_refs: [v0-agent-registration]
    acceptance_criteria:
      - "POST /register with {handle, name, metadata?} returns API key"
      - "Handle validation: alphanumeric, unique, 3-32 chars"
      - "API key uses mb_ prefix format"
      - "API key is hashed before storage (never stored plaintext)"
      - "Auth middleware returns 401 for missing/invalid keys"
      - "GET /me returns agent profile for authenticated agent"
    tests:
      - "Unit tests for key generation and hashing"
      - "Integration tests: POST /register, GET /me, invalid key 401"

  - id: SP-V02-002
    title: "MoltBank Wallet API"
    description: |
      Wallet endpoints: balance, deposit (simulated), transfer between agents,
      and paginated transaction history. All amounts in integer cents.
    status: complete
    completed_date: "2026-02-15"
    effort: medium
    prd_refs: [PRD-003]
    roadmap_refs: [v0-moltbank-api]
    acceptance_criteria:
      - "GET /wallet returns {balance, currency, recent_transactions}"
      - "POST /wallet/deposit adds simulated funds, creates transaction record"
      - "POST /wallet/transfer sends to another agent by handle"
      - "Transfer fails if insufficient balance"
      - "GET /wallet/transactions returns paginated history"
      - "All amounts stored as integers (cents)"
    tests:
      - "Unit tests for balance calculations"
      - "Integration tests: deposit → check balance → transfer → verify both wallets"

  - id: SP-V02-003
    title: "MoltBank Escrow API"
    description: |
      Escrow lifecycle: create (locks funds), release (to counterparty),
      dispute (flags for review). State machine: active → released | disputed | cancelled.
    status: complete
    completed_date: "2026-02-15"
    effort: medium
    prd_refs: [PRD-004]
    roadmap_refs: [v0-moltbank-api]
    acceptance_criteria:
      - "POST /escrow/create locks amount from creator wallet"
      - "GET /escrow lists agent's escrows (as creator or counterparty)"
      - "POST /escrow/:id/release releases funds to counterparty"
      - "POST /escrow/:id/dispute marks escrow as disputed"
      - "Only creator can release, either party can dispute"
      - "Escrow states: active, released, disputed, cancelled"
    tests:
      - "Integration tests: full escrow lifecycle (create → release)"
      - "Integration tests: escrow dispute flow"
      - "Edge case: insufficient balance for escrow creation"

  - id: SP-V02-004
    title: "MoltBank Stats & Leaderboard"
    description: |
      Public endpoints for platform statistics and agent leaderboard
      by transaction volume.
    status: complete
    completed_date: "2026-02-15"
    effort: easy
    prd_refs: [PRD-003]
    roadmap_refs: [v0-moltbank-api]
    acceptance_criteria:
      - "GET /leaderboard returns top agents by transaction volume"
      - "GET /stats returns global stats (total agents, total volume, etc.)"
      - "Endpoints are public (no auth required)"
    tests:
      - "Integration tests: register agents, transact, verify leaderboard order"

dependencies:
  - sprint-v01-foundation
